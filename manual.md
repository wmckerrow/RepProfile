# RepProfile Manual

##Setup
RepProfile requires no compiling. However it does require that the following python libraries be installed:
- Bio
- pysam
- numpy
- scipy

Running the QuickStart example will also require bwa and samtools.

RepProfile has been run using python 2.7.3. It is likely not compatible with python 3.

##Quick start example
The QuickStart directory contains a small simulated data set of hyper-edited reads. The files reads_R1.fastq and reads_R2.fastq contain reads simulated from the abbreviated repeat genome someFB.fa.

The first step is to create candidate reads. Executing the script
```bash
utilities/make_candidate_alignments.sh 
```
will use bwa to generate candidates.masked.aln.bam. The reads in this bam file are masked so that any number of A to G changes can appear in an alignment.

Running RepProfile is divided into two steps. First the candidate alignments are store as several pickle files for quick reading by RepProfile.
```bash
python main/parse_PEbam_for_RepProfile.py -b candidates.masked.aln.bam -r QuickStart/reads_R1.fastq,QuickStart/reads_R2.fastq -g QuickStart/someFB.fa -m 4
```
Second, RepProfile will use the EM algorithm to estimate the profile and expression levels:
```bash
python main/RepProfile.py -a alignments_list.txt -r QuickStart/someFB.fa -p QuickStart/HyperEditingPrior.txt -n 5
```

Once the profile has been estimated, a RepProfile alignment in bam format can be generated:
```bash
samtools view -H candidates.masked.aln.bam > QS.sam
python utilities/write_sam.py >> QS.sam
samtools view -bS QS.sam | samtools sort - -o QS.bam
rm QS.sam
```

A list of repeats that are hyper-edited can be reported:
```bash
python utilities/report.py -r hyper_f,hyper_r
```

A list of edited positions can also be reported:
```bash
python utilities/report.py -p edit_f,edit_r
```

##Building a repeat genome
At this time, RepProfile is intended to be used one repeat at a time. The script utilities/make_repeat_genome.py will create a repeat genome. For example
```bash
python utilities/make_repeat_genome.py -r FB4_DM -f 1000 -m dm6.reps.bed -g dm6.fa > FB4_DM.1000.fa
```
will generate a fasta with one record for each instance of FB4_DM together with 1000 bases of flanking sequence.

- -r FB4_DM indicates that the new fasta should include only repeats named FB4_DM. If you are providing a bed file that only contains the target repeat, you do not need to specifiy -r.
- -f 1000 indicates that 1000 bases of flanking sequences are desired. If the flanking of two repeats overlap, they will merged into a single record.
- -m dm6.reps.bed points toward a bed file indicating where in the genome repeats can be found. This can be generated by downloading the repeatmasker track as a bed file from the UCSC genome browser.
- -g dm6.fa points to the reference that repeat genome should be cut out of.

##Collecting repeat reads

##Candidate alignment bam
As RepProfile does compute a sum across all alignments, it needs a set of candidate alignments as input. These alignments should be in bam format. The bam must by sorted by name. Alternate alignments can be either given as XA tags or as new lines. The script utilities/make_candidate_alignments.sh will use bwa to create a candidate alignment bam that includes alignments with any number of A to G changes but at most four non A to G mismatches. The first three lines of the script specify the fastq and fasta files to align.

##Parsing the candidate bam file
Before a profile can be estimated, the bam file is parsed and the alignments are split into pickle files. Only alignments that are concordant and overlap part of the repeat (not the flanking) are retained. Reads with no such alignments are discarded. The bam parsing is done by main/parse_PEbam_for_RepProfile.py. For example:
```bash
python main/parse_PEbam_for_RepProfile.py -b candidates.masked.aln.bam -r QuickStart/reads_R1.fastq,QuickStart/reads_R2.fastq -g QuickStart/someFB.fa -m 4
```

- -b candidates.masked.aln.bam points toward the bam file containing candidate alignments
- -r QuickStart/reads_R1.fastq,QuickStart/reads_R2.fastq points toward fastq files containing the reads. The paired end reads should appear in two files and their names should be seperated by a comma.
- -g QuickStart/someFB.fa points toward the repeat genome.
- -m 4 means that any read with more than 4 non A to G mismatches will be thrown out.

The following optional arguments can be specified:
- (-p/--prefix) By default candidate alignments are written to alignments_0.pkl,...,alignments_n.pkl. You can specify a prefix to replace "alignments."
- (-k/--flanking) Fragments that lie entirely within the flanking sequence are skipped. By default the first and last 1000 bases of each sequence are assumed be flanking. Another number can be specified here.
- (-n/--reads_per_pickle) To control memory usage, the reads are split into different files that are read one at a time by each core. By default each file contains 5000 reads. This number can be changed here. If you are using multiple threads in RepProfile.py, make sure that you have more alignment pickles than threads.
- (-q/--qcutoff) By default only reads that have mean base call quality at least 30 are considered.

##Running RepProfile
The actual profile estimation is done by main/RepProfile.py. It can be executed as follows:
```bash
python main/RepProfile.py -a alignments_list.txt -r QuickStart/someFB.fa -p QuickStart/HyperEditingPrior.txt -n 5
```
- -a alignments_list.txt points to a file listing the alignment pickles generated by parse_PEbam_for_RepProfile.py. The file alignments_list.txt is generated automatically.
- -r QuickStart/someFB.fa points to the reference genome.
- -p QuickStart/HyperEditingPrior.txt points to a file that specifies the prior distribution. The provided prior QuickStart/HyperEditingPrior.txt is for estimating hyper-editing and is the prior used in our paper.
- -n 5 specifies that 5 EM steps should be taken.

The following additional options can also be used:
- (-j/--jumps) If an integer > 0 is specified, RepProfile will try to find a better profile by decreasing the number of hyper edited TEs and then taking the specified number of EM steps. Only compatible with the hyper editing prior.
- (-c/--coverage) You can specify an initial guess for expression levels. Looks for two files separated by a comma. One for the forward strand and one for the reverse. For example:
-c plus_cov.txt,minus_cov.txt 

where plus_cov.txt and minus_cov.txt are tab delimited files in which the first column is the name of a repeat and the second column is a relative expression level. If a repeat is not listed a value of 1.0 is used.

Further arguments that can be specified are:
- (-i/--intial_guess) Specify an initial guess. This should point to four pickle files separated by commas. For example
-i genome_profile_f.pkl,genome_profile_r.pkl,f_prob.pkl,r_prob.pkl
will use the profile learned in the last run of RepProfile as the initial guess when running EM. genome_profile_f.pkl and genome_profile_r.pkl should be python dictionaries in which the keys are the names of the repeats and the values are nx4 numpy arrays, where n is the length of the repeat. The (i,j) entry should be the probability of nucleotide j and position i, where A=0,C=1,G=2, T=3 and N=4. f_prob.pkl and r_prob.pkl should be dictionaries, in which the keys are the names of repeats and the values are the probability that a random read in the +/- orientation comes from that repeat.
- (-k/--flanking) The default amount of flanking is 1000 nucleotides. If you are using a different amount of flanking specify it here.
- (-t/--threads) RepProfile uses 8 cores by default. Another number can be specified here.

##Building a samfile
The script utilities/write_sam.py will report the most likely alignment of each accepted read in sam format. It will not make a sam header, so if you want to convert to bam format, you will need to copy the header from the candidate alignments bam. A bamfile can be generated as follows:
```bash
samtools view -H candidates.masked.aln.bam > QS.sam
python utilities/write_sam.py >> QS.sam
samtools view -bS QS.sam | samtools sort - -o QS.bam
rm QS.sam
```
By default the profile is read from genome_profile_f.pkl, genome_profile_r.pkl, f_prob.pkl and r_prob.pkl and alignments are read from pickles listed in alignment_list.txt. You can specify other file to read the alignments and profile from using the following options:
- (-a/--alignment_pickles_list) Specify another file to list the alignment pickles to consider. The default would be -a alignment_list.txt.
- (-f/--prob_pickles) Specify pickles containing the probability that a read comes from a given repeat. The default would be -f f_prob.pkl,r_prob.pkl
- (-t/--genome_profile) Specify the forward and reverse strand profile. The default would be -t genome_profile_f.pkl,genome_profile_r.pkl

##Reporting predictions
In the process of estimating the profile, RepProfile also calculates a most likely repeat state for each repeat and a most likely position state for each position. In the case of the hyper editing prior, this means predicting which repeats are hyper edited, which specific positions are edited and where the SNPs are. These predictions can be printed with utilities/report.py. For example:
```bash
python utilities/report.py -r hyper_f,hyper_r
```
will report which repeats are in the hyper_f (hyper edited on the forward strand) state and which repeats and in the hyper_r (hyper edited on the reverse strand) state. Likewise,
```bash
python utilities/report.py -p edit_f,edit_r,SNP1,SNP2,SNP3
```
will report positions that are edited on the forward strand (edit_f), edited on the reverse strand (edit_r) or SNPs (SNP1,SNP2,SNP3). Three SNP states are used the cover the three possible types of bialellic SNPs.

You can also report the probability of certain bases. For example
```bash
python utilities/report.py -p edit_f,edit_r -n G,C
```
will report any position that is estimated to be along with the fraction of editing that is predicted.
```bash
python utilities/report.py -p SNP1,SNP2,SNP3 -n ACGT,ACGT
```
will report any SNP positions along with the profile at those positions.

make_repeat_genome.fa will save the genomic coordinates of repeats in the fasta file. You can use this information to report the genomic coordinates of predictions:
- (-g/--genomic_positions) will point toward a repeat reference fasta file to draw genomic coordinates from.

By default, report.py reads from the default RepProfile output file in the current working directory. You can specify other files to read from:
- (-R/--rep_type_pickle) Will point to the pickle file to read repeat states from.
- (-P/--pos_type_pickle) Will point to the pickle file to read position states from.
- (-G/-genome_profile_pickles) Will point to the pickle files (comma separated) specifying forward and reverse genome profiles.

Furthermore, if you are not using 1000 base pairs of flanking sequence you will need to include that with (-f/--flanking)

##The prior
NB: The current prior assumes that the forward and reverse profiles are identical. Allowing different profiles at edited positions led to unwanted predictions when reads only align to one strand.

RepProfile uses a three tiered prior. At the top level, each repeat has a repeat state. At the second level, each position has a position state. The probability that a position is in a given state depends on the state of the repeat that that position is in. Finally each position state specifies a Dirichlet distribution. The bottom tier is the profile which is drawn from that Dirichlet distribution.

The prior is read from a text file that is divided into three parts. A single line "END" separate each of the parts. Lines beginning with # are ignored. See QuickStart/HyperEditingPrior.txt for an example.

The first set of lines specify the repeat states with two fields. The first names the state and the second specifies the probability of a repeat being in that state. For example
```
not	0.98
```
specifies that there is a repeat state "not" and that each repeat has as 98% chance of being in that state. Each repeat state must be listed exactly once and the probabilities should add up to 1.

The second set of lines have four fields and specify the position states:

1. The name of the state
2. The Dirichlet parameters for the prior for reads oriented in the + direction. The parameter vector is mod the reference base. Thus if 10.0,0.01,0.01,0.01 is specified, the profile will be drawn from Dirichlet(10.0,0.01,0.01,0.01) if the reference is A, but Dirichlet(0.01,0.01,0.01,10.0) if the reference is T.
3. The Dirichlet parameters for the prior for reads oriented in the - direction.
4. 1 if the + and - strand should have the same profile. 0 if not.
end{enumerate}
For example:
```
ref	10.0,0.01,0.01,0.01	10.0,0.01,0.01,0.01	1
```
specifies a state names "ref." A single profile drawn from Dirichlet(10.0,0.01,0.01,0.01) describes reads oriented on the + or - strand. And
```
edit_f	1.0,0.01,1.0,0.01	10.0,0.01,0.01,0.01	0
```
specifies a state "edit_f" for which one profile is drawn from Dirichlet(1.0,0.01,1.0,0.01) and describes + oriented reads and another is drawn from Dirichlet(10.0,0.01,0.01,0.01) to describe - oriented reads.

Each position state should appear on exactly one line.

Finally the third set of lines specifies the probability of each repeat state. The lines have four fields:
1. The name of the position state(s)
2. The name of the repeat state(s)
3. A set of bases (A=0,C=1,G=2,T=3,N=4)
4. The probability of being in each of the position states given one of the repeat states when the reference is one of the given bases.
Combinations that are not specified have 0 probability. For example:
```
ref	hyper_f	0	0.495
```
says that if the repeat state is "hyper_f" and the reference base is "A" then there is a 0.495 probability of being in position state "ref."
snp1,snp3	hyper_f,hyper_r,not	0,1,2,3	0.0025
says that under any repeat state and any base, the probability of snp1 and snp3 are 0.0025.

##Jumping
We found that in some cases RepProfile converges to a local max, predicting hyper editing in too many repeats. To find the global max or at least a better local max, RepProfile can try new initial conditions that will consolidate hyper-editing in fewer repeats with the -j option. Enabling jumping will require many more EM steps, but it might result in a much better estimate. The jumping scheme is only implemented for the provided profile QuickStart/HyperEditingProfile.txt. You may edit the probabilities within the prior and the alpha parameter. As long you keep the same repeat and position state names and retain the following facts:
- edit_f is only allowed in hyper_f
- Profiles in edit_f are a mixture of A/G
- edit_r is only allowed in hyper_t
- Profiles in edit_t are a mixture of T/C
